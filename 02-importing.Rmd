# Importing data {#import}

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(lubridate)
library(tidyices)
```

## Data download

Download the raw data using the `getDATRAS` function from the [icesDatras](https://github.com/ices-tools-prod/icesDatras)-package and store it for later retrieval.

```{r, eval = FALSE}
# not run
yrs <- 1975:2018
qts <- c(1, 3)
hh_raw <- 
  icesDatras::getDATRAS(record = "HH", survey = "NS-IBTS", years = yrs, quarters = qts)
hl_raw <- 
  icesDatras::getDATRAS(record = "HL", survey = "NS-IBTS", years = yrs, quarters = qts)
ca_raw <- 
  icesDatras::getDATRAS(record = "CA", survey = "NS-IBTS", years = yrs, quarters = qts)
species <- tidyices::get_latin()

nsibts_raw <- list(hh = hh_raw, hl = hl_raw, ca = ca_raw, sp = species)
save(nsibts_raw, file = "data/nsibts_raw.rda")
write_rds(species, "data/species_code.rda")
```

## Data tidying

Lets load the raw data we have imported earlier:

```{r}
load("data/nsibts_raw.rda")
```


### The haul data

The haul dataframe contains one record per haul and is in a relatively tidy format. The function `tidy_hh` does the following:

* The unique key: The linkage to other dataframes is through the combined key of year, quarter, ship, gear and haulno. In order to facilitate linkage these variables are combined into a single unique key names **id**. In the haul table the original variables are retained.
* A datetime variable: Information of the date and time of haul shot are stored in four variables: year, month, day and timeshot. These variables are combined into a single **datetime** variable.
* By default, only selected variables are returned, these being: id, year,
quarter, survey, ship, gear, haulno, date, country, depth, haulval, hauldur,
shootlat, shootlong, haullat, haullong,
statrec, daynight, datatype, stdspecreccode, bycspecreccode)


```{r, message = FALSE, warning = FALSE, eval = FALSE}
hh <-
  nsibts_raw$hh %>% 
  tidyices::tidy_hh()
```

#### Roundfish area

In this booklet one largely works with the NS-IBTS data. In some of the steps the "Roundfish area" is used. This 
```{r, message = FALSE, warning = FALSE, eval = FALSE}
ns_area <- rgdal::readOGR("data-raw/NS_IBTS_RF.dbf", verbose = FALSE)
hh <-
  hh %>% 
  mutate(area = gisland::geo_inside(shootlong, shootlat, ns_area, "AreaName"))
```


### The length data

Processing:

* Only distinct records (they are all distinct)
* Filter out data were species code, length-code and length-class are undefined
* Set lengths to millimeter. In the raw records:
    - If **lngtcode** is "1" then the **lngtclass** is in centimeters
    - If **lngtcode** is "." or "0" then the **lngclass** is in millimeters
* Standardise the **haul numbers at length**. In the raw data:
    - If **datatype** in the station table is "C" then **hlnoatlngt** has been standardized to 60 minutes haul
    - If **datatype** in the station table is "R" then **hlnoatlngt** has not been standardized to 60 minutes haul
* Get the latin species name from the `sp`-table
* Select only variable that are needed in further processing
    
```{r, message = FALSE, warning = FALSE, eval = FALSE}
species <- read_rds("data/species.rda")
hl <-
  nsibts_raw$hl %>% 
  tidyices::tidy_hl(hh, species) %>% 
  select(-species)
```

### The age data

```{r, eval = FALSE}
ca <-
  nsibts_raw$ca %>% 
  tidyices::tidy_ca(species = species) %>% 
  select(-species)
```

### Save stuff for later use

```{r, eval = FALSE}
hh %>% write_rds("data/nsibts_hh.rds")
hl %>% write_rds("data/nsibts_hl.rds")
ca %>% write_rds("data/nsibts_ca.rds")
```

