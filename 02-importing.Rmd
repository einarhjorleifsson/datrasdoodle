# Importing data {#import}

```{r, warning = FALSE, message = FALSE}
library(lubridate)
library(stringr)
library(tidyices)
library(tidyverse)
```

## Data download

Download the raw data using the `getDATRAS` function from the [icesDatras](https://github.com/ices-tools-prod/icesDatras)-package and store it for later retrieval.

```{r, eval = FALSE}
# not run
yrs <- 1975:2017
qts <- c(1, 3)
raw_hh <- 
  icesDatras::getDATRAS(record = "HH", survey = "NS-IBTS", years = yrs, quarters = qts)
raw_hl <- 
  icesDatras::getDATRAS(record = "HL", survey = "NS-IBTS", years = yrs, quarters = qts)
raw_ca <- 
  icesDatras::getDATRAS(record = "CA", survey = "NS-IBTS", years = yrs, quarters = qts)
species <- tidyices::get_latin(raw_hl)

save(raw_hh, raw_hl, raw_ca, species, file = "data/raw_data.rda")
```

## Data tidying

```{r, eval = FALSE}
attach("data/raw_data.rda")
```

### The station data

<!-- Need to explain the area stuff -->

```{r, message = FALSE, warning = FALSE, eval = FALSE}
hh <-
  raw_hh %>%
  tidyices::tidy_hauls()
ns_area <- rgdal::readOGR("data-raw/NS_IBTS_RF.dbf", verbose = FALSE)
hh <-
  hh %>% 
  mutate(area = gisland::geo_inside(shootlong, shootlat, ns_area, "AreaName"))
```


### The length data

Processing:

* Only distinct records (they are all distinct)
* Filter out data were species code, length-code and length-class are undefined
* Set lengths to millimeter. In the raw records:
    - If **lngtcode** is "1" then the **lngtclass** is in centimeters
    - If **lngtcode** is "." or "0" then the **lngclass** is in millimeters
* Standardise the **haul numbers at length**. In the raw data:
    - If **datatype** in the station table is "C" then **hlnoatlngt** has been standardized to 60 minutes haul
    - If **datatype** in the station table is "R" then **hlnoatlngt** has not been standardized to 60 minutes haul
* Get the latin species name from the `sp`-table
* Select only variable that are needed in further processing
    
```{r, message = FALSE, warning = FALSE, eval = FALSE}
hl <-
  raw_hl %>%
  tidyices::tidy_lengths(hh, species) %>% 
  select(-species)
```

### The age data

```{r, eval = FALSE}
ca <-
  raw_ca %>% 
  tidyices::tidy_ages(species = species) %>% 
  select(-species)
```

### Save stuff for later use

```{r, eval = FALSE}
nsibts_tidy <- list(hh = hh, hl = hl, ca = ca, sp = species)
save(nsibts_tidy, file = "data/nsibts_tidy.rda")
```

