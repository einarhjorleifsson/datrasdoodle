# Importing data {#import}

```{r, warning = FALSE, message = FALSE}
library(lubridate)
library(stringr)
library(tidyverse)
```

## Data download

Download the raw data using the `getDATRAS` function from the [icesDatras](https://github.com/ices-tools-prod/icesDatras)-package and store it for later retrieval.

```{r, eval = FALSE}
# not run
st <- icesDatras::getDATRAS("HH", "NS-IBTS", 1975:2017, 1)
le <- icesDatras::getDATRAS("HL", "NS-IBTS", 1975:2017, 1)
ag <- icesDatras::getDATRAS("CA", "NS-IBTS", 1975:2017, 1)

nsibts_raw <- list(st = st, le = le, ag = ag)
save(nsibts_raw, file = "data/nsibts_raw.rda")
```

## Data tidying

```{r, eval = FALSE}
attach("data/nsibts_raw.rda")
```

### The station data

<!-- Need to explain the area stuff -->

```{r, message = FALSE, warning = FALSE, eval = FALSE}
ns_area <- rgdal::readOGR("data-raw/NS_IBTS_RF.dbf", verbose = FALSE)
ST <- nsibts_raw$st
# Turn column names lower case
colnames(ST) <- tolower(colnames(ST))
ST <- 
  ST %>% 
  # create a unique station id
  unite(id, year, quarter, ship, gear, haulno, remove = FALSE) %>%
  # get proper date
  mutate(timeshot = stringr::str_pad(timeshot, width = 4, side = "left", pad = "0"),
         timeshot = paste0(stringr::str_sub(timeshot, 1, 2),
                           ":",
                           stringr::str_sub(timeshot, 3, 4)),
         datetime = lubridate::ymd_hm(paste(year, month, day, timeshot))) %>% 
  # Get roundfish area
  mutate(area = gisland::geo_inside(shootlong, shootlat, ns_area, "AreaName")) %>% 
  # only valid hauls
  filter(haulval == "V",
         # only in roundfish area
         !is.na(area)) %>% 
  # select only "needed" column
  select(id, survey, year, quarter, ship, gear, haulno, hauldur,
         shootlat, shootlong, datetime, depth, 
         area, subarea = statrec, daynight, datatype) %>% 
  tbl_df()
```


### The length data

Processing:

* Only distinct records (they are all distinct)
* Filter out data were species code, length-code and length-class are undefined
* Set lengths to millimeter. In the raw records:
    - If **lngtcode** is "1" then the **lngtclass** is in centimeters
    - If **lngtcode** is "." or "0" then the **lngclass** is in millimeters
* Standardise the **haul numbers at length**. In the raw data:
    - If **datatype** in the station table is "C" then **hlnoatlngt** has been standardized to 60 minutes haul
    - If **datatype** in the station table is "R" then **hlnoatlngt** has not been standardized to 60 minutes haul
* Get the latin species name from the `sp`-table
* Select only variable that are needed in further processing
    
```{r, message = FALSE, warning = FALSE, eval = FALSE}
# read in species code
SP <- read_csv("data-raw/SPCODE.csv")
LE <- nsibts_raw$le
colnames(LE) <- tolower(colnames(LE))
LE <-
  LE %>%
  distinct() %>%
  filter(!is.na(speccode), !is.na(lngtclass), !is.na(lngtcode)) %>%
  # EINAR - not sure if this is right, done here to test if any difference
  #         (did though not help with respect to discrepancy here below)
  #filter(specval == 1) %>% 
  unite(id, year, quarter, ship, gear, haulno) %>%
  # only stations that are in the station table (north sea ibts)
  #  may be reduntant
  filter(id %in% ST$id) %>% 
  # length class to mm
  mutate(length = ifelse(lngtcode %in% c("1"), lngtclass * 10, lngtclass),
         hlnoatlngt = hlnoatlngt * subfactor) %>% 
  # get the data type and hauldur
  left_join(ST %>% select(id, datatype, hauldur)) %>% 
  # catch per hour
  mutate(n = ifelse(datatype == "R",
                    hlnoatlngt * 60 / hauldur,
                    hlnoatlngt)) %>% 
  # join with latin name
  left_join(SP) %>%
  # select only needed columns
  select(id, latin, sex, length, n) %>% 
  tbl_df()
```

### The age data

```{r, eval = FALSE}
AG <- nsibts_raw$ag
colnames(AG) <- tolower(colnames(AG))
AG <- 
  AG %>% 
  unite(id, year, quarter, ship, gear, haulno) %>% 
  # turn everything to cm
  mutate(length = ifelse(!lngtcode %in% c("1"), lngtclass / 10, lngtclass), 
         indwgt = ifelse(indwgt <= 0, NA, indwgt)) %>% 
  left_join(SP) %>% 
  select(id, latin, length, sex, maturity, age, wgt = indwgt, n = noatalk) 
```

### Save stuff for later use

```{r, eval = FALSE}
nsibts_tidy <- list(ST = ST, LE = LE, AG = AG)
save(nsibts_tidy, file = "data/nsibts_tidy.rda")
```

```{r}
attach("data/nsibts_tidy.rda")
```

