# Haul data {#haul}



## Preamble

It is recomended that every session in R is started by declaring/loading all the libraries needed to run the session:

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(lubridate)
library(mapdata)
library(gisland)
```

Besides loading up the needed it is recomended that the data used is imported upfront. Here we will import the tidy NS-IBTS downloaded and tidyied in the Introduction, this time around we only need the haul data:

```{r}
hh <- 
  read_rds("data/ns-ibts_hh.rds") %>% 
  # TODO: Move this upstream, into the tidy_hh function
  #       Should set code up so that it works separately on character and
  #       numerical vectors
  mutate_all(funs(ifelse(.==-9, NA_real_, .))) %>% 
  mutate_all(funs(ifelse(.=="-9", NA_character_, .)))
```

## Temporal overview

```{r}
hh %>% 
  filter(haulval == "V") %>% 
  group_by(year, quarter, gear) %>% 
  count() %>% 
  ggplot(aes(year, n)) +
  #theme_minimal() +
  geom_point() +
  #geom_line() +
  facet_grid(gear ~ quarter) +
  scale_colour_brewer(palette = "Set1")
```

```{r}
hh %>% 
  filter(haulval == "V",
         gear == "GOV") %>% 
  group_by(year, quarter, country) %>% 
  count() %>% 
  ggplot(aes(year, n)) +
  #theme_minimal() +
  geom_point() +
  #geom_line() +
  facet_grid(country ~ quarter) +
  scale_colour_brewer(palette = "Set1")
```

```{r}
hh %>% 
  filter(haulval == "V") %>% 
  mutate(quarter = paste("Quarter", quarter)) %>% 
  ggplot(aes(factor(year), hauldur)) +
  geom_boxplot(outlier.size = 0.25, fill = "pink", alpha = 0.2) +
  facet_grid(quarter ~ .) +
  scale_x_discrete(breaks = seq(1965, 2025, by = 5)) +
  scale_y_continuous(breaks = c(0, 30, 60, 90)) +
  expand_limits(y = 0) +
  labs(x = NULL, y = "Haul duration [minutes]",
       title = "NS-IBTS",
       subtitle = "Distribution of haulduration")
```


## Spatial overview

Like most fisheries data survey data are spatial in nature. So it is only natural to start to attempt to get a spatial overview of the survey coverage. 


Lets generate a base map:
```{r}
xlim <- c(-4, 13)
ylim <- c(49, 62)
m <- map_data("worldHires", xlim = xlim, ylim = ylim)
p <- 
  ggplot() +
  #theme_bw() +
  geom_polygon(data = m, aes(long, lat, group = group), fill = "grey") +
  scale_x_continuous(name = NULL, minor_breaks = NULL, breaks = seq(-10, 20, by = 1)) +
  scale_y_continuous(name = NULL, breaks = seq(49, 65, by = 1)) +
  coord_quickmap(xlim = xlim, ylim = ylim, expand = FALSE)
p
```

```{r}
d <-
  hh %>% 
  filter(year == 2013,
         haulval == "V") 
p +
  geom_segment(data = d, aes(x = shootlong, y = shootlat, xend = haullong, yend = haullat,
                   colour = ship), lwd = 2) +
  scale_color_brewer(palette = "Set1") +
  #theme(legend.position = c(0.8, 0.2)) +
  labs(colour = "Quarter") +
  facet_wrap(~ quarter)
```

```{r}
d <-
  hh %>% 
  filter(haulval == "V",
         year == 2017) %>% 
  mutate(lon = grade(shootlong, 1),
         lat = grade(shootlat, 0.5)) %>% 
  group_by(lon, lat, quarter) %>% 
  count()
d %>% 
  ggplot() +
  geom_raster(aes(lon, lat, fill = n)) +
  scale_fill_viridis_c(option = "B", direction = -1, breaks = c(1:5), guide = "legend") +
  geom_polygon(data = m, aes(long, lat, group = group), fill = "grey") +
  coord_quickmap(xlim = xlim, ylim = ylim, expand = FALSE) +
  facet_wrap(~ quarter)
```

```{r}
p <- 
  ggplot() +
  theme_bw() +
  scale_x_continuous(name = NULL, minor_breaks = NULL, breaks = seq(-10, 20, by = 1)) +
  scale_y_continuous(name = NULL, breaks = seq(49, 65, by = 1)) +
  coord_quickmap(xlim = xlim, ylim = ylim, expand = FALSE)
p +
  geom_raster(data = d, aes(lon, lat, fill = n)) +
  geom_polygon(data = m, aes(long, lat, group = group), fill = "grey") +
  scale_fill_viridis_c(option = "B", direction = -1, breaks = c(1:5), guide = "legend") +
  facet_wrap(~ quarter)
```

```{r}
d <-
  hh %>% 
  filter(haulval == "V",
         quarter == 1,
         year %in% c(1965:1980)) 
p + 
  geom_point(data = d, aes(shootlong, shootlat, colour = gear)) +
  facet_wrap(~ year) +
  scale_colour_brewer(palette = "Set3") +
  scale_x_continuous(labels = NULL) +
  scale_y_continuous(labels = NULL) +
  labs(x = NULL, y = NULL,
       title = "NS-IBTS",
       subtitle = "Spatial expansion and gear used")
```

