# Length data {#length}

```{r, warning = FALSE, message = FALSE}
library(lubridate)
library(stringr)
library(tidyices)
library(tidyverse)
library(ggjoy)
```


```{r}
load("data/nsibts_tidy.rda")
```

## CPUE per length per haul
___

```{r}
common <- c("Clupea harengus", "Sprattus sprattus", "Gadus morhua",
            "Melanogrammus aeglefinus", "Merlangius merlangus", "Pollachius virens",
            "Trisopterus esmarkii", "Scomber scombrus", "Pleuronectes platessa")
cpue <- 
  #                        only valid hauls
  cpue_per_length_per_haul(st = nsibts_tidy$hh %>% filter(haulval == "V",
                                                          !is.na(area)),
                           le = nsibts_tidy$hl) %>% 
  filter(latin %in% common) %>% 
  # debugging, this should be fixed upstream
  filter(!is.na(length))
```

#### Comparison Datras service product

```{r, message = FALSE, warning = FALSE}
cpue2 <-
  cpue %>%
  id_separate(remove = FALSE) %>%
  filter(year %in% 2005:2016) %>% 
  select(id, latin, length, cpue.tidy = n) %>% 
  mutate(length = as.integer(length * 10))
fi <- 
  "~/prj2/bookdown/datrasdoodle/data-raw/CPUE_per_length_per_haul.csv"
cpue.datras.service.product <-
  read_csv(fi, na = "-9")
colnames(cpue.datras.service.product) <- 
  tolower(colnames(cpue.datras.service.product))
cpue.datras.service.product <-
  cpue.datras.service.product %>%
  filter(year %in% 2005:2016) %>% 
  id_unite() %>% 
  select(id, latin = species, length = lngtclass, cpue.dsp = cpue_number_per_hour) %>% 
  as_tibble()

diff <-
  cpue2 %>% 
  full_join(cpue.datras.service.product) %>%
  mutate(diff = !near(cpue.dsp, cpue.tidy, tol = 1e-4),
         txt = ifelse(!diff, "Same",
                      ifelse(diff, "Difference", "One of the value is NA")))
diff %>% 
  group_by(txt) %>% 
  summarise(n.records = n()) %>% 
  knitr::kable()
```

We have 515584 records that are OK and then 953 records that are different. We have 1642 values that are "NA" meaning that either of the cpue or both were missing.

```{r}
x <- diff %>% filter(is.na(txt))
table(!is.na(x$cpue.tidy), !is.na(x$cpue.dsp))
```

So have 1374 observations that are in "tidy" but not in "dsp" and 268 observations in "dsp" that are not in "tidy"

**Lets print the 268 observations that are not in "tidy"**:

```{r}
diff %>% 
  filter(is.na(txt), !is.na(cpue.dsp)) %>% 
  arrange(latin) %>% 
  knitr::kable()
```

What is the story with the single haddock?:
```{r}
load("data/raw_data.rda")
colnames(raw_hl) <- tolower(colnames(raw_hl))
raw_hl %>% 
  as_tibble() %>% 
  id_unite() %>% 
  filter(id == "2009_1_THA2_GOV_26",
         valid_aphia == 126437) %>% glimpse()
```

So, it does not appear in the raw_hl dataframe. And because these are all of `lngtcode == "0"` these fish are what is termed as 0.5 cm length class, reporting units of millimeter. For the time being this does not quite make sense in my head.

What do we have in tidy for the haul and species in question?:
```{r}
cpue2 %>% 
  filter(id == "2009_1_THA2_GOV_26",
         latin == "Melanogrammus aeglefinus") %>% glimpse()
```

So no 20 cm fish

And in the dsp:
```{r}
cpue.datras.service.product %>% 
  filter(id == "2009_1_THA2_GOV_26",
         latin == "Melanogrammus aeglefinus") %>% glimpse()
```

We have only 20, 30 and 40 cm fish. So it seems like in the dsp the length class are treated as millimeters that are then converted to centimeters by rounding.

### Some simple summaries

```{r, message = FALSE, warning = FALSE}
d <-
  cpue %>% 
  mutate(b = n * 0.01 * length^3) %>% 
  group_by(id, latin) %>% 
  summarise(n = sum(n),
            b = sum(b)) %>%
  separate(id, c("year", "quarter", "ship", "gear", "haulno"), convert = TRUE) %>%
  mutate(year = year + quarter/4)

d %>% 
  ggplot(aes(year, n, colour = factor(quarter))) +
  stat_summary(fun.data = "mean_cl_boot", size = 0.1) +
  expand_limits(y = 0) +
  facet_wrap(~ latin, scale = "free_y") +
  scale_color_brewer(palette = "Set1") +
  labs(x = NULL, y = NULL,
       colour = "Quarter",
       title = "Annual abundance",
       subtitle = "Bootstrap mean and confidence interval of individual tows")
d %>% 
  ggplot(aes(year, b, colour = factor(quarter))) +
  stat_summary(fun.data = "mean_cl_boot", size = 0.1) +
  expand_limits(y = 0) +
  facet_wrap(~ latin, scale = "free_y") +
  scale_color_brewer(palette = "Set1") +
  labs(x = NULL, y = NULL,
       colour = "Quarter",
       title = "Annual biomass",
       subtitle = "Bootstrap mean and confidence interval of individual tows")
```


```{r, message = FALSE, warning = FALSE}
d <-
  cpue %>%
  mutate(b = n * 0.01 * length^3) %>% 
  id_separate() %>% 
  group_by(year, quarter, latin, length) %>% 
  summarise(n = sum(n),
            b = sum(b)) %>% 
  ungroup()
d %>%
  filter(latin == "Melanogrammus aeglefinus",
         year >= 1998,
         quarter == 1,
         between(length, 9, 45)) %>% 
  ggplot(aes(length,  as.factor(year), group = year, height = n)) +
  geom_joy(stat = "identity", scale = 5, alpha = 0.5)
d %>%
  filter(latin == "Gadus morhua",
         year >= 2000,
         quarter == 1,
         between(length, 5, 100)) %>% 
  ggplot(aes(length,  as.factor(year), height = b)) +
  geom_joy(stat = "identity", scale = 3, alpha = 0.5) +
  scale_x_continuous(breaks = seq(0, 120, by = 10))
d %>%
  filter(latin == "Pleuronectes platessa",
         year >= 2000,
         quarter == 1) %>% 
  ggplot(aes(length, as.factor(year), height = n)) +
  geom_joy(stat = "identity", alpha = 0.5)
```


## Field names
___

* **StNo**: National coding system, not defined by ICES
* **HaulNo**: Sequential numbering of hauls during cruise. In CA-records: HaulNo = -9 for Area-based ALK HaulNo <> -9 and > 0 for Haul-based ALK
* **DataType**:
    - -9: Invalid haul
    - C: Data calculated as CPUE (number per hour)
    - R: Data by haul
    - S: Subsample data
* **SpecCodeType**:
    - N: NODC code
    - T: TSN code
    - W: WoRMS ApiaID code
* **LngtCode**:
    - .:	1 mm length class, reporting units: mm
    - 0:	0.5 cm length class, reporting units: mm
    - 1:	1 cm length class, reporting units: cm
* **CatIdentifier**: Category for subsampling for species, length, weight, and sex. If **DataType** is C, **CatIdentifier** is always 1. For further description and examples of use look up the manual.
* **SubFactor**: Sub-sampling factor. If 1/6 of the catch was measured, report 6. If **DataType** is:
    - C: it should be reported as 1. 
    - S: it is always >1.
    - R: the SubFactor is = 1 or >1 for different species depending on whether they were subsampled.
