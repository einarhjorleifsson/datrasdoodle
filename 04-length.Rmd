# Length data {#length}

## Preamble
___

Load libraries and data:

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(lubridate)
library(tidyices)
library(ggridges)
```

```{r}
hh <- read_rds("data/ns-ibts_hh.rds")
hl <- read_rds("data/ns-ibts_hl.rds")
```

## Catch per haul

Since the length data are standardized to 60 minutes it is easy to calculate the standardized abundance per haul.

```{r}
by.haul <- 
  hl %>% 
  group_by(id) %>% 
  summarise(n = sum(n))
```

In the code above we have basically collapsed the abundance by species and length going from `r nrow(hl)` observations) to `r nrow(by.haul)` observations. 

Now the latter value only refers to the number of hauls where some fish was recorded (or rather where any length measurements where taken), while the total number of stations in the full dataset is the number of rows in the `hh`-dataframe (`r nrow(hh)` hauls). The difference represents the number of zero stations. Now in order to include the stations with zero catch we:

* Take the haul data and do a left join with the length data which have some catch recorded
* This results in the zero stations having NA in the n variable. Hence the mutate in combination with ifelse comes to the rescue, setting a value of zero as count for stations where no fish was caught otherwise retain the count value.

```{r}
by.haul <-
  hh %>% 
  left_join(by.haul) %>%
  mutate(n = ifelse(is.na(n), 0, n))
```

A quick count:
```{r}
table(by.haul$haulval, by.haul$n == 0)
```

reveals that we have 27702 valid hauls with fish and 6 valid hauls where no fish was caught.

Since we are here we may as well look at the temporal trend in the median abundance using only the valid hauls:

```{r}
by.haul %>% 
  filter(haulval == "V") %>% 
  group_by(year, quarter) %>% 
  summarise(m = mean(n)) %>% 
  ggplot(aes(year, m)) +
  geom_point() +
  geom_line() +
  facet_wrap(~ quarter)
```

So we are talking about some 10-30 thousand fish being caught per 60 minutes haul with the quarter 3 survey generally showing higher mean than the quarter 1 survey. Using the mean may not be appropriate here, given the general distribution of abundance by haul one observes in groundfish surveys:

```{r}
by.haul %>% 
  filter(haulval == "V") %>% 
  # put the values above the 99%th percentile to 99%th percentile
  mutate(n = ifelse(n > quantile(n, 0.99), quantile(n, 0.99), n)) %>% 
  ggplot(aes(n)) +
  geom_histogram()
```

The ggplot2 package has a very nice summary statistics that comes to the rescue:

```{r}
by.haul %>% 
  filter(haulval == "V") %>% 
  ggplot(aes(year, n, colour = factor(quarter))) +
  stat_summary(fun.data = "mean_cl_boot", size = 0.1) +
  expand_limits(y = 0) +
  scale_color_brewer(palette = "Set1") +
  labs(x = NULL, y = NULL,
       colour = "Quarter",
       title = "Annual abundance",
       subtitle = "Bootstrap mean and confidence interval")
```

A minor tweaking in the code would also allow us to address the question on the mean number of species that have been caught per haul (or is it only the mean of the species where length measurements are taken??) through time:
```{r}
hh %>% 
  filter(haulval == "V") %>% 
  left_join(hl %>% 
              group_by(id) %>% 
              summarise(n.species = n_distinct(latin))) %>% 
  ggplot(aes(year, n.species, colour = factor(quarter))) +
  stat_summary(fun.data = "mean_cl_boot", size = 0.1) +
  expand_limits(y = 0) +
  scale_color_brewer(palette = "Set1") +
  labs(x = NULL, y = NULL,
       colour = "Quarter",
       title = "Number of species per haul",
       subtitle = "Bootstrap mean and confidence interval")
```


## Size spectrum

```{r}
hl %>% 
  mutate(length = floor(length)) %>% 
  group_by(id, length) %>% 
  summarise(n = mean(n)) %>% 
  id_separate() %>% 
  group_by(year, quarter, length) %>% 
  summarise(m = mean(n)) %>% 
  filter(quarter == 1,
         #length <= 50,
         year %in% seq(1980, 2020, by = 5)) %>% 
  ggplot(aes(length, m, colour = factor(year))) +
  geom_line() +
  #scale_x_log10() +
  scale_y_log10()
```



```{r}
by.haul %>% 
  filter(year == 2017) %>% 
  ggplot(aes(shootlong, shootlat, size = n)) +
  geom_point(colour = "red", alpha = 0.3) + 
  scale_size_area(max_size = 10) +
  coord_quickmap() +
  facet_wrap(~ quarter)
```

```{r}
hh %>% 
  left_join(hl %>%
              mutate(b = n * 0.00001 * length^3) %>% 
              group_by(id) %>% 
              summarise(b = sum(b))) %>% 
  filter(year == 2017) %>% 
   ggplot(aes(shootlong, shootlat, size = b)) +
  geom_point(colour = "red", alpha = 0.3) + 
  scale_size_area(max_size = 10) +
  coord_quickmap() +
  facet_wrap(~ quarter)
```


## CPUE per length per haul
___

```{r}
common <- c("Clupea harengus", "Sprattus sprattus", "Gadus morhua",
            "Melanogrammus aeglefinus", "Merlangius merlangus", "Pollachius virens",
            "Trisopterus esmarkii", "Scomber scombrus", "Pleuronectes platessa")
cpue <- 
  # only valid hauls
  cpue_per_length_per_haul(hh = hh %>% filter(haulval == "V", !is.na(nsarea)),
                           hl = hl) %>% 
  filter(latin %in% common) %>% 
  # debugging, this should be fixed upstream
  filter(!is.na(length))
```

#### Comparison Datras service product

```{r, message = FALSE, warning = FALSE}
cpue2 <-
  cpue %>%
  id_separate(remove = FALSE) %>%
  filter(year %in% 2005:2016) %>% 
  select(id, latin, length, cpue.tidy = n) %>% 
  mutate(length = as.integer(length * 10))
fi <- 
  "data-raw/CPUE per length per haul per hour_2018-06-30 15_34_50.csv"
cpue.datras.service.product <-
  read_csv(fi, na = "-9") %>% 
  rename_all(tolower)
cpue.datras.service.product <-
  cpue.datras.service.product %>%
  filter(year %in% 2005:2016) %>% 
  id_unite() %>% 
  select(id, latin = species, length = lngtclass, cpue.dsp = cpue_number_per_hour) %>% 
  as_tibble()

diff <-
  cpue2 %>% 
  full_join(cpue.datras.service.product) %>%
  mutate(diff = !near(cpue.dsp, cpue.tidy, tol = 1e-4),
         txt = ifelse(!diff, "Same",
                      ifelse(diff, "Difference", "One of the value is NA")))
diff %>% 
  group_by(txt) %>% 
  summarise(n.records = n()) %>% 
  knitr::kable()
```

We have 515584 records that are OK and then 953 records that are different. We have 1642 values that are "NA" meaning that either of the cpue or both were missing.

```{r}
x <- diff %>% filter(is.na(txt))
table(!is.na(x$cpue.tidy), !is.na(x$cpue.dsp))
```

So have 1374 observations that are in "tidy" but not in "dsp" and 268 observations in "dsp" that are not in "tidy"

**Lets print the 268 observations that are not in "tidy"**:

```{r}
diff %>% 
  filter(is.na(txt), !is.na(cpue.dsp)) %>% 
  arrange(latin) %>% 
  knitr::kable()
```

What is the story with the single haddock?:
```{r}
raw <- read_rds("data-raw/datras/ns-ibts_raw.rds")
hl_raw <-
  raw$hl %>% 
  rename_all(tolower)
hl_raw %>% 
  as_tibble() %>% 
  id_unite() %>% 
  filter(id == "2009_1_THA2_GOV_26",
         valid_aphia == 126437) %>% glimpse()
```

So, it does not appear in the hl_raw dataframe. And because these are all of `lngtcode == "0"` these fish are what is termed as 0.5 cm length class, reporting units of millimeter. For the time being this does not quite make sense in my head.

What do we have in tidy for the haul and species in question?:
```{r}
cpue2 %>% 
  filter(id == "2009_1_THA2_GOV_26",
         latin == "Melanogrammus aeglefinus") %>% glimpse()
```

So no 20 cm fish

And in the dsp:
```{r}
cpue.datras.service.product %>% 
  filter(id == "2009_1_THA2_GOV_26",
         latin == "Melanogrammus aeglefinus") %>% glimpse()
```

We have only 20, 30 and 40 cm fish. So it seems like in the dsp the length class are treated as millimeters that are then converted to centimeters by rounding.

### Some simple summaries

```{r, message = FALSE, warning = FALSE}
d <-
  cpue %>% 
  mutate(b = n * 1e-5 * length^3) %>% 
  group_by(id, latin) %>% 
  summarise(n = sum(n),
            b = sum(b)) %>%
  separate(id, c("year", "quarter", "ship", "gear", "haulno"), convert = TRUE) %>%
  mutate(year = year + quarter/4)

d %>% 
  ggplot(aes(year, n, colour = factor(quarter))) +
  stat_summary(fun.data = "mean_cl_boot", size = 0.1) +
  expand_limits(y = 0) +
  facet_wrap(~ latin, scale = "free_y") +
  scale_color_brewer(palette = "Set1") +
  labs(x = NULL, y = NULL,
       colour = "Quarter",
       title = "Annual abundance",
       subtitle = "Bootstrap mean and confidence interval of individual standardized tow duration [60 minutes]")
d %>% 
  ggplot(aes(year, b, colour = factor(quarter))) +
  stat_summary(fun.data = "mean_cl_boot", size = 0.1) +
  expand_limits(y = 0) +
  facet_wrap(~ latin, scale = "free_y") +
  scale_color_brewer(palette = "Set1") +
  scale_x_continuous(name = NULL, breaks = seq(1960, 2020, by = 10)) +
  scale_y_continuous(name = NULL, labels = NULL) +
  labs(colour = "Quarter",
       title = "Annual biomass",
       subtitle = "Bootstrap mean and confidence interval of individual standardized tow duration [60 minutes]")
```


```{r, message = FALSE, warning = FALSE}
d <-
  cpue %>%
  mutate(b = n * 0.01 * length^3) %>% 
  id_separate() %>% 
  group_by(year, quarter, latin, length) %>% 
  summarise(n = sum(n),
            b = sum(b)) %>% 
  ungroup()
d %>%
  filter(latin == "Melanogrammus aeglefinus",
         year >= 1998,
         quarter == 1,
         between(length, 9, 45)) %>% 
  ggplot(aes(length,  as.factor(year), group = year, height = n/1e5)) +
  geom_ridgeline(stat = "identity", scale = 5, alpha = 0.5)
d %>%
  filter(latin == "Gadus morhua",
         year >= 2000,
         quarter == 1,
         between(length, 5, 100)) %>% 
  ggplot(aes(length,  as.factor(year), height = n/1e3)) +
  geom_ridgeline(stat = "identity", scale = 3, alpha = 0.5) +
  scale_x_continuous(breaks = seq(0, 120, by = 10))
d %>%
  filter(latin == "Pleuronectes platessa",
         year >= 2000,
         quarter == 1) %>% 
  ggplot(aes(length, as.factor(year), height = n/1e3)) +
  geom_ridgeline(stat = "identity", alpha = 0.5)
```


## Field names
___

* **StNo**: National coding system, not defined by ICES
* **HaulNo**: Sequential numbering of hauls during cruise. In CA-records: HaulNo = -9 for Area-based ALK HaulNo <> -9 and > 0 for Haul-based ALK
* **DataType**:
    - -9: Invalid haul
    - C: Data calculated as CPUE (number per hour)
    - R: Data by haul
    - S: Subsample data
* **SpecCodeType**:
    - N: NODC code
    - T: TSN code
    - W: WoRMS ApiaID code
* **LngtCode**:
    - .:	1 mm length class, reporting units: mm
    - 0:	0.5 cm length class, reporting units: mm
    - 1:	1 cm length class, reporting units: cm
* **CatIdentifier**: Category for subsampling for species, length, weight, and sex. If **DataType** is C, **CatIdentifier** is always 1. For further description and examples of use look up the manual.
* **SubFactor**: Sub-sampling factor. If 1/6 of the catch was measured, report 6. If **DataType** is:
    - C: it should be reported as 1. 
    - S: it is always >1.
    - R: the SubFactor is = 1 or >1 for different species depending on whether they were subsampled.
