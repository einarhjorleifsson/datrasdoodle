# Age based indices {#alk}

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(lubridate)
library(patchwork)
```

```{r}
hh <- read_rds("data/ns-ibts_hh.rds")
hl <- read_rds("data/ns-ibts_hl.rds")
ca <- read_rds("data/ns-ibts_ca.rds")
```

## Converting length to age

### The principle

Length data are relatively cheap to record relative to age data, because for the latter one needs to read annual rings from hard structure (normally otoliths) which require often laborious preparatory work in addition to counting rings. Hence in surveys the length measurements are more numerous, the objective being to estimate with good accuracy the length distribution of the catch at each station while otoliths are only collected from a smaller subsample of the catch.

The sub-samples of the age data is then used to calculate the probability of age for a given length class, generally called an age-length key (alk). This data is then used to split the length data into age classes.

Lets summarize some length frequency and age-length data for one species in one survey:
```{r}
Latin <- "Gadus morhua"
lfs <-
  hh %>% 
  filter(year == 2014,
         quarter == 3) %>% 
  select(id) %>% 
  left_join(hl, by = "id") %>% 
  filter(latin == Latin) %>% 
  mutate(length = floor(length)) %>% 
  group_by(length) %>% 
  summarise(n = sum(n, na.rm = TRUE)) %>% 
  drop_na()
p1 <-
  lfs %>% 
  ggplot(aes(length, n)) +
  theme_grey() +
  geom_col() +
  labs(x = NULL,
       subtitle = "Length frequency")
alk <-
  hh %>% 
  filter(year == 2014,
         quarter == 3) %>% 
  select(id) %>% 
  left_join(ca, by = "id") %>% 
  filter(latin == Latin) %>% 
  mutate(length = floor(length),
         age = ifelse(age > 9, 9, age)) %>% 
  group_by(age, length) %>% 
  summarise(n = sum(n)) %>% 
  group_by(length) %>% 
  mutate(p = n / sum(n, na.rm = TRUE)) %>% 
  select(-n) %>% 
  drop_na()
p2 <-
  alk %>% 
  mutate(age = ifelse(age > 9, 9, age)) %>% 
  ggplot(aes(length, p, fill = factor(age))) +
  theme_grey() +
  scale_fill_brewer(palette = "Set3") +
  geom_col() +
  labs(x = "Length",
       y = "Proportion",
       fill = "Age",
       subtitle = "Proportion of age at length")

p1 + p2 + plot_layout(ncol = 1)
```

In principle we want to split the each length class of the length distribution (top graph) into separate age groups based on the age-length key (lower graph). Visually this may be easy for the first mode, almost all fish in each length class belonging to age group 0. Beyond that, each length class is most often composed of more than one age groups. 

Lets look at the alk for the 70 cm length class:
```{r}
alk %>% 
  filter(length == 70) %>% 
  knitr::kable()
```

Here we have 5 age-classes in the length class, the most numerous ones being age 3 (50%), then 4 (22%) and 5 (17%), while around 6% of the fish are of age 2 and 6.

We use this probability to split each length class into ages. Here we simply have to join joining the length-frequency and the alk dataframes and split the count tally (n) in each length group into number of fish at each age (n.nage) by multiply the number measured by length with the probability:

```{r}
d <- 
  lfs %>% 
  left_join(alk, by = "length") %>% 
  mutate(n.age = p * n)
```

If we check the 70 cm length class again we have:
```{r}
d %>% 
  filter(length == 70) %>% 
  knitr::kable()
```

Visually we have now the following:

```{r}
d %>% 
  ggplot(aes(length, n.age, fill = factor(age))) +
  theme_grey() +
  geom_col() +
  scale_fill_brewer(palette = "Set3") +
  labs(x = "Length",
       y = "n",
       fill = "Age",
       subtitle = "Length frequency by age")
```

We can now also look at the age distribution:
```{r}
d %>% 
  group_by(age) %>% 
  summarise(n.age = sum(n.age, na.rm = TRUE)) %>% 
  drop_na() %>% 
  ggplot(aes(age, n.age)) +
  geom_col() +
  scale_x_continuous(breaks = 0:10) +
  labs(x = "Age",
       y = "n")
```

### Age based indices
