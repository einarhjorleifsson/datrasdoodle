# Age-length keys {#alk}

```{r, warning = FALSE, message = FALSE}
library(ggmisc)
library(viridis)
library(lubridate)
library(stringr)
library(tidyices)
library(tidyverse)
```

```{r}
load("data/nsibts_tidy.rda")
```

## Quick overview

```{r, message = FALSE, warning = FALSE}
d <- nsibts_tidy$ca %>% filter(latin == "Gadus morhua")
# here ignore year, quarter and area
alk <- 
  d %>% 
  filter(!is.na(age)) %>% 
  # get round fish area - not needed at this stage
  left_join(nsibts_tidy$hh %>% select(id, area)) %>% 
  # round length to the neares length class
  #   ?? should one use floor here?
  mutate(length = as.integer(round(length, 0))) %>% 
  group_by(latin, age, length) %>% 
  # not sure if i am supposed to summarise the noatalk
  #  or just count the line, here count the lines
  summarise(n = n()) %>% 
  ungroup()
# probability that a certain length class is of certain age
alk <- 
  alk %>% 
  group_by(length) %>% 
  mutate(p = n/sum(n, na.rm = TRUE))  %>% 
  ungroup()
alk %>% 
  ggplot(aes(age, length, fill = p)) +
  geom_raster() +
  scale_fill_viridis(direction = -1)
alk %>% 
  ggplot(aes(length, p, fill = factor(age))) + 
  geom_col() + 
  scale_fill_crayola(name = "Age") +
  scale_x_continuous("Length [cm]", breaks = seq(0, 150, by = 10)) +
  scale_y_continuous("Probability", breaks = seq(0, 1, by = 0.1))
nsibts_tidy$hl %>% 
  filter(latin == "Gadus morhua") %>% 
  mutate(length = round(length/10, 0)) %>% 
  group_by(length) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(length, n)) +
  geom_col() +
  scale_x_continuous("Length [cm]", breaks = seq(0, 150, by = 10))
alk %>% 
  filter(length %in% c(40, 45, 50, 55, 60)) %>% 
  ggplot(aes(age, p)) +
  geom_point() +
  geom_line() +
  facet_grid(length ~ .)
```

## Year, quarter, species

```{r}
common <- c("Clupea harengus", "Sprattus sprattus", "Gadus morhua",
            "Melanogrammus aeglefinus", "Merlangius merlangus", "Pollachius virens",
            "Trisopterus esmarkii", "Scomber scombrus", "Pleuronectes platessa")
alk <- 
  nsibts_tidy$ca %>% 
  filter(!is.na(age)) %>% 
  # get round fish area - actually ignored here
  left_join(nsibts_tidy$hh %>% select(id, area)) %>% 
  filter(!is.na(area)) %>% 
  id_separate() %>% 
  as_tibble() %>% 
  # round length to the neares length class
  #   ?? should one use floor here?
  mutate(length = as.integer(round(length, 0))) %>% 
  group_by(year, quarter, latin, age, length) %>% 
  # not sure if i am supposed to summarise the noatalk
  #  or just count the line, here count the lines
  summarise(n = n()) %>% 
  ungroup() %>%
  group_by(year, quarter, latin, length) %>% 
  mutate(p = n/sum(n, na.rm = TRUE))  %>% 
  ungroup() %>% 
  filter(latin %in% common)
le <- 
  cpue_per_length_per_haul(st = nsibts_tidy$hh, le = nsibts_tidy$hl) %>% 
  id_separate() %>% 
  group_by(year, quarter, latin, length) %>% 
  summarise(n = sum(n)) %>% 
  filter(latin %in% common)
x <-
  alk %>%
  select(-n) %>% 
  left_join(le %>% mutate(length = length/10)) %>% 
  group_by(year, quarter, latin, age) %>% 
  summarise(n = sum(p * n, na.rm = TRUE))
library(ggmisc)
x %>% 
  filter(latin == "Melanogrammus aeglefinus",
         quarter == 1,
         age %in% 1:10) %>% 
  mutate(yc = year - age) %>% 
  ggplot(aes(year, n, fill = factor(yc))) +
  geom_col() +
  facet_grid(age ~ ., scale = "free_y") +
  scale_fill_crayola() +
  theme(legend.position = "none") +
  scale_y_continuous(NULL, NULL) +
  labs(x = NULL)
```



```{r}
d %>% 
  ggplot(aes(length, wgt)) +
  geom_point(size = 0.25)
d %>% 
  group_by(id) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(n)) + 
  geom_histogram(binwidth = 1) +
  scale_y_log10(breaks = c(1, 2, 4, 8, 16, 64, 250, 1000))
d %>% filter(age <= 9) %>% ggplot(aes(length)) + geom_histogram()
d %>% 
  filter(age <= 9) %>% 
  ggplot(aes(length, colour = factor(age))) + 
  geom_freqpoly() +
  scale_color_brewer(palette = "Set1")
d %>% 
  filter(age <= 8) %>% 
  ggplot(aes(length)) +
  theme_bw() +
  geom_histogram(binwidth = 5) +
  scale_color_brewer(palette = "Set1") +
  scale_y_continuous(NULL, NULL) +
  scale_x_continuous(breaks = seq(0, 150, by = 25)) +
  coord_flip() +
  facet_grid(. ~ age, scale = "free_x")
```

