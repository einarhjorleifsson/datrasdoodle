# Common models {#models}

## Length weight

## von Bertalanffy

## Maturity 0give

... Something about the model

### One species

Lets start with only focusing on one species.

```{r warning = FALSE, message = FALSE}
library(tidyverse)
library(modelr)
ca <- read_rds("data/ns-ibts_ca.rds")
d <- 
  ca %>% 
  filter(latin == "Pleuronectes platessa") %>% 
  # CHECK: Not sure if this is correct
  mutate(mature = ifelse(maturity %in% c(1, 61), 0, 1)) %>% 
  drop_na() %>% 
  filter(sex %in% c("M", "F"))
```

An empirical fit:

```{r}
d2 <-
  d %>% 
  group_by(age) %>% 
  summarise(p = sum(mature/n()),
            n = n())

model <- glm(mature ~ age, data = d, family = binomial)

grid <-
  data_frame(age = seq_range(d$age, 20)) %>% 
  mutate(pY = predict(model, newdata = ., type = 'response'))

ggplot(d, aes(x = age)) +
  geom_point(aes(y = mature)) +
  geom_line(data = grid, aes(y = pY)) +
  geom_point(data = d2, aes(y = p), colour = "red")
  
model <- glm(mature ~ age + sex, data = d, family = binomial)

grid <-
  d %>% 
  data_grid(age, sex) %>% 
  mutate(pY = predict(model, newdata = ., type = 'response'))
# or
library(broom)
res <-
  d %>% 
  data_grid(age, sex) %>% 
  augment(x = model, newdata = ., type.predict = "response") %>% 
  as_tibble()

grid %>% 
  ggplot(aes(age, pY, colour = sex)) +
  geom_line() +
  expand_limits(y = 0)

# or just
ggplot(d, aes(age, mature, colour = sex)) + 
    geom_point() + 
    geom_smooth(method = 'glm', method.args = list(family = 'binomial')) + 
    scale_y_continuous()
```


```{r message = FALSE}
common <- c("Clupea harengus", "Sprattus sprattus", "Gadus morhua",
            "Melanogrammus aeglefinus", "Merlangius merlangus", "Pollachius virens",
            "Trisopterus esmarkii", "Scomber scombrus", "Pleuronectes platessa")
d <- 
  ca %>% 
  filter(latin %in% common) %>% 
  as_tibble() %>% 
  mutate(mature = ifelse(maturity %in% c(1, 61), 0, 1)) %>% 
  drop_na() %>% 
  filter(sex %in% c("M", "F"))


res <-
  d %>% 
  group_by(latin) %>%
  do(tidy(glm(mature ~ age, data = ., family = binomial)))
res <- 
  d %>% 
  group_by(latin) %>%
  do(fit = glm(mature ~ age, data = ., family = binomial))
res
res %>% tidy(fit)
res %>% glance(fit)
# here really want to predict using new shorter data frame

res %>% 
  augment(fit, type.predict = "response") %>% 
  filter(age <= 10) %>% 
  ggplot(aes(age, .fitted, colour = latin)) +
  geom_line(lwd = 1) +
  scale_colour_brewer(palette = "Set1") +
  scale_x_continuous(breaks = 0:10) +
  theme(legend.position = c(0.75, 0.3)) +
  expand_limits(y = 0)
```

